name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Lint and type check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Type check client
        working-directory: client
        run: npx tsc --noEmit

      - name: Type check server
        working-directory: server
        run: npx tsc --noEmit

  # Build Docker images
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build client image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: false
          tags: chat-client:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build server image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: false
          tags: chat-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Validate Kubernetes manifests
  validate-k8s:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          curl -L -o kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate manifests
        run: |
          kubeconform -summary -strict k8s/*.yaml

  # Full Kubernetes integration test
  k8s-integration:
    name: Kubernetes Integration Test
    runs-on: ubuntu-latest
    needs: [build, validate-k8s]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images for testing
        run: |
          docker build -t chat-client:latest ./client
          docker build -t chat-server:latest ./server

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          config: k8s/kind-config.yaml
          cluster_name: chat-app-test

      - name: Load images into kind
        run: |
          kind load docker-image chat-client:latest --name chat-app-test
          kind load docker-image chat-server:latest --name chat-app-test

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Deploy application
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/server-deployment.yaml
          kubectl apply -f k8s/server-service.yaml
          kubectl apply -f k8s/client-deployment.yaml
          kubectl apply -f k8s/client-service.yaml
          kubectl apply -f k8s/ingress.yaml

      - name: Wait for deployments
        run: |
          kubectl wait --namespace chat-app \
            --for=condition=available deployment/chat-server \
            --timeout=120s
          kubectl wait --namespace chat-app \
            --for=condition=available deployment/chat-client \
            --timeout=120s

      - name: Verify pods are running
        run: |
          kubectl get pods -n chat-app
          kubectl get pods -n chat-app | grep -q "Running" || exit 1

      - name: Test health endpoint
        run: |
          # Port forward to test the health endpoint
          kubectl port-forward -n chat-app svc/chat-server 3001:3001 &
          sleep 5
          curl -f http://localhost:3001/health || exit 1

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Server Logs ==="
          kubectl logs -n chat-app -l app.kubernetes.io/name=chat-server --tail=100
          echo "=== Client Logs ==="
          kubectl logs -n chat-app -l app.kubernetes.io/name=chat-client --tail=100
          echo "=== Events ==="
          kubectl get events -n chat-app --sort-by='.lastTimestamp'
